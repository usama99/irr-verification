<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRR Link Verification Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .login-box, .main-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        input[type="password"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .hidden {
            display: none;
        }

        .search-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-box {
            flex: 1;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .country-group {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .country-group:hover {
            border-color: #667eea;
        }

        .country-header {
            padding: 20px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .country-header:hover {
            background: #e9ecef;
        }

        .country-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .country-count {
            color: #667eea;
            font-weight: bold;
        }

        .country-preview {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .country-actions {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: #fff;
            border-top: 1px solid #e0e0e0;
        }

        .country-actions button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }

        .action-active {
            background: #28a745;
        }

        .action-obsolete {
            background: #dc3545;
        }

        .action-details {
            background: #6c757d;
        }

        .country-details {
            padding: 20px;
            background: #fff;
            border-top: 1px solid #e0e0e0;
        }

        .peer-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .peer-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .peer-as {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .peer-org {
            font-size: 13px;
            color: #666;
        }

        .submit-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .submit-btn {
            padding: 15px 40px;
            font-size: 18px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .error {
            color: #dc3545;
            margin-top: 10px;
        }

        .success {
            color: #28a745;
            margin-top: 10px;
        }

        .contact {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            color: #856404;
        }

        .verification-summary {
            margin-top: 20px;
            padding: 15px;
            background: #d4edda;
            border-radius: 8px;
            color: #155724;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="login-box">
            <h1>ðŸ”’ IRR Link Verification Portal</h1>
            <p class="subtitle">Verify your AS's IRR links - Grouped by peer country for quick verification</p>
            <input type="password" id="passwordInput" placeholder="Enter access password" onkeypress="if(event.key==='Enter') login()">
            <button onclick="login()">Access Portal</button>
            <p id="loginError" class="error hidden">Incorrect password. Please try again.</p>
            <div class="contact">
                <strong>Questions?</strong> Contact: usamaijaz404@gmail.com
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="main-content hidden">
            <h1>IRR Link Verification</h1>
            <p class="subtitle">Verify your AS's IRR links - Peers grouped by country for efficient verification</p>

            <!-- Search Section -->
            <div class="search-section">
                <h3 style="margin-bottom: 15px;">Find Your AS</h3>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="asnInput" placeholder="Enter AS number (e.g., 1234 or AS1234)" onkeypress="if(event.key==='Enter') searchAS()">
                    <button onclick="searchAS()">Search</button>
                </div>
                <div id="loadingMessage" class="loading hidden">Loading data...</div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <!-- Stats -->
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-label">Your AS</div>
                        <div class="stat-value" id="currentAS">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Total Peer Links</div>
                        <div class="stat-value" id="linkCount">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Peer Countries</div>
                        <div class="stat-value" id="countryCount">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Verified</div>
                        <div class="stat-value" id="verifiedCount">0</div>
                    </div>
                </div>

                <!-- Country Groups -->
                <div id="countryGroupsContainer"></div>

                <!-- Verification Summary -->
                <div id="verificationSummary" class="verification-summary hidden">
                    <h3>âœ“ Verification Summary</h3>
                    <div id="summaryContent"></div>
                </div>

                <!-- Submit Section -->
                <div class="submit-section">
                    <button class="submit-btn" onclick="submitVerification()">Submit Verification</button>
                    <p class="subtitle" style="margin-top: 10px;">
                        Your responses will be automatically saved. A backup file will also download.
                    </p>
                </div>
            </div>

            <div class="contact">
                <strong>Questions or issues?</strong> Email: usamaijaz404@gmail.com
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================

        const PASSWORD_HASH = "deda38a7fa94cdc6863168750cac646efa25ff2e2a67babe979b46c3cb36b9ee"; // CHANGE THIS!
        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfNAFdeWfeQ9RS-e2sQgysgGnPy75hl9BsJL3c-zMnXaC1yyA/formResponse";
        const FORM_FIELDS = {
            asn: "entry.1255619771",
            email: "entry.847494780",
            data: "entry.143108106",
            timestamp: "entry.969579197"
        };

        // ============================================
        // STATE
        // ============================================

        let countryIndex = {}; // Maps ASN -> country filename
        let currentASN = '';
        let currentASData = null;
        let countryVerifications = {}; // {country: 'active'|'obsolete'}

        // ============================================
        // PASSWORD & DATA LOADING
        // ============================================

        async function login() {
            const password = document.getElementById('passwordInput').value;
            const hash = await sha256(password);

            if (hash === PASSWORD_HASH) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                loadCountryIndex();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function loadCountryIndex() {
            try {
                const response = await fetch('data/country_index.json');
                countryIndex = await response.json();
                console.log('Country index loaded:', Object.keys(countryIndex).length, 'ASes');
            } catch (error) {
                alert('Error loading country index. Please contact support.');
                console.error(error);
            }
        }

        // ============================================
        // SEARCH & LOAD
        // ============================================

        async function searchAS() {
            const input = document.getElementById('asnInput').value.trim();
            const asn = input.replace(/^AS/i, '');

            if (!asn) {
                alert('Please enter an AS number.');
                return;
            }

            if (!countryIndex[asn]) {
                alert(`AS${asn} not found in our dataset.`);
                return;
            }

            currentASN = asn;
            countryVerifications = {};

            // Show loading
            document.getElementById('loadingMessage').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');

            // Load country file
            const countryFile = countryIndex[asn].filename;
            console.log(`Loading ${countryFile} for AS${asn}...`);

            try {
                const response = await fetch(`data/${countryFile}`);
                const countryData = await response.json();

                if (!countryData[asn]) {
                    alert(`AS${asn} not found in ${countryFile}.`);
                    return;
                }

                currentASData = countryData[asn];

                // Group peers by country IN BROWSER
                groupPeersByCountry();

                // Display
                displayResults();

                // Hide loading
                document.getElementById('loadingMessage').classList.add('hidden');

            } catch (error) {
                alert('Error loading AS data. Please try again.');
                console.error(error);
                document.getElementById('loadingMessage').classList.add('hidden');
            }
        }

        function groupPeersByCountry() {
            // Group peers by their country (done in browser!)
            const grouped = {};

            for (const link of currentASData.links) {
                const peerCountry = link.peer_country || 'Unknown';

                if (!grouped[peerCountry]) {
                    grouped[peerCountry] = {
                        count: 0,
                        peers: []
                    };
                }

                grouped[peerCountry].count++;
                grouped[peerCountry].peers.push(link);
            }

            // Sort by count (descending)
            const sortedGrouped = {};
            const sortedCountries = Object.keys(grouped).sort((a, b) =>
                grouped[b].count - grouped[a].count
            );

            for (const country of sortedCountries) {
                sortedGrouped[country] = grouped[country];
            }

            currentASData.grouped_by_country = sortedGrouped;
        }

        function displayResults() {
            const data = currentASData;
            const asInfo = data.as_info || {};
            const grouped = data.grouped_by_country || {};

            // Update stats
            const asDisplay = asInfo.name && asInfo.name !== 'Unknown'
                ? `AS${currentASN} - ${asInfo.name} (${asInfo.country})`
                : `AS${currentASN}`;

            document.getElementById('currentAS').textContent = asDisplay;
            document.getElementById('linkCount').textContent = data.links.length;
            document.getElementById('countryCount').textContent = Object.keys(grouped).length;
            document.getElementById('verifiedCount').textContent = '0';

            // Display country groups
            displayCountryGroups(grouped);

            // Show results section
            document.getElementById('resultsSection').classList.remove('hidden');

            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function displayCountryGroups(grouped) {
            const container = document.getElementById('countryGroupsContainer');
            container.innerHTML = '';

            const countryFlags = {
                'Singapore': 'ðŸ‡¸ðŸ‡¬', 'United States': 'ðŸ‡ºðŸ‡¸', 'Japan': 'ðŸ‡¯ðŸ‡µ',
                'Indonesia': 'ðŸ‡®ðŸ‡©', 'Australia': 'ðŸ‡¦ðŸ‡º', 'Germany': 'ðŸ‡©ðŸ‡ª',
                'United Kingdom': 'ðŸ‡¬ðŸ‡§', 'Netherlands': 'ðŸ‡³ðŸ‡±', 'France': 'ðŸ‡«ðŸ‡·',
                'China': 'ðŸ‡¨ðŸ‡³', 'India': 'ðŸ‡®ðŸ‡³', 'Malaysia': 'ðŸ‡²ðŸ‡¾',
                'Thailand': 'ðŸ‡¹ðŸ‡­', 'South Korea': 'ðŸ‡°ðŸ‡·', 'Canada': 'ðŸ‡¨ðŸ‡¦',
            };

            for (const [country, group] of Object.entries(grouped)) {
                const flag = countryFlags[country] || 'ðŸŒ';
                const countryDiv = createCountryGroup(country, group, flag);
                container.appendChild(countryDiv);
            }
        }

        function createCountryGroup(country, group, flag) {
            const div = document.createElement('div');
            div.className = 'country-group';
            div.id = `country-${country.replace(/\s+/g, '-')}`;

            const previewPeers = group.peers.slice(0, 3).map(p => p.peer_name).join(', ');
            const moreText = group.peers.length > 3 ? ` and ${group.peers.length - 3} more` : '';

            div.innerHTML = `
                <div class="country-header" onclick="toggleCountryDetails('${country}')">
                    <div>
                        <div class="country-title">
                            ${flag} ${country} <span class="country-count">(${group.count} peers)</span>
                        </div>
                        <div class="country-preview">${previewPeers}${moreText}</div>
                    </div>
                    <div>â–¼</div>
                </div>
                <div class="country-actions">
                    <button class="action-active" onclick="markCountry('${country}', 'active', event)">
                        âœ“ Mark All Active
                    </button>
                    <button class="action-obsolete" onclick="markCountry('${country}', 'obsolete', event)">
                        âœ— Mark All Obsolete
                    </button>
                    <button class="action-details" onclick="toggleCountryDetails('${country}', event)">
                        Show Details
                    </button>
                </div>
                <div class="country-details hidden" id="details-${country.replace(/\s+/g, '-')}">
                    <h4 style="margin-bottom: 10px;">All ${country} Peers:</h4>
                    <div class="peer-list">
                        ${group.peers.map(peer => `
                            <div class="peer-item">
                                <div class="peer-as">AS${peer.peer_as} - ${peer.peer_name}</div>
                                <div class="peer-org">${peer.peer_org}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            return div;
        }

        function toggleCountryDetails(country, event) {
            if (event) event.stopPropagation();
            const detailsId = `details-${country.replace(/\s+/g, '-')}`;
            const details = document.getElementById(detailsId);
            details.classList.toggle('hidden');
        }

        function markCountry(country, status, event) {
            event.stopPropagation();
            countryVerifications[country] = status;
            updateVerifiedCount();
            showVerificationSummary();
        }

        function updateVerifiedCount() {
            const verified = Object.keys(countryVerifications).length;
            document.getElementById('verifiedCount').textContent = verified;
        }

        function showVerificationSummary() {
            const summary = document.getElementById('verificationSummary');
            const content = document.getElementById('summaryContent');

            if (Object.keys(countryVerifications).length === 0) {
                summary.classList.add('hidden');
                return;
            }

            const activeCountries = [];
            const obsoleteCountries = [];

            for (const [country, status] of Object.entries(countryVerifications)) {
                if (status === 'active') {
                    activeCountries.push(country);
                } else if (status === 'obsolete') {
                    obsoleteCountries.push(country);
                }
            }

            let html = '<ul style="list-style: none; padding: 0;">';
            if (activeCountries.length > 0) {
                html += `<li><strong>Active:</strong> ${activeCountries.join(', ')}</li>`;
            }
            if (obsoleteCountries.length > 0) {
                html += `<li><strong>Obsolete:</strong> ${obsoleteCountries.join(', ')}</li>`;
            }
            html += '</ul>';

            content.innerHTML = html;
            summary.classList.remove('hidden');
        }

        // ============================================
        // SUBMISSION
        // ============================================

        async function submitVerification() {
            if (Object.keys(countryVerifications).length === 0) {
                alert('Please verify at least one country group before submitting.');
                return;
            }

            const data = {
                asn: currentASN,
                as_info: currentASData.as_info,
                country_verifications: countryVerifications,
                timestamp: new Date().toISOString(),
                total_countries: Object.keys(currentASData.grouped_by_country).length,
                verified_countries: Object.keys(countryVerifications).length
            };

            await submitToGoogleForm(data);
            downloadJSONBackup(data);

            alert('âœ“ Verification submitted successfully! Thank you for your contribution.');
        }

        async function submitToGoogleForm(data) {
            const formData = new FormData();
            formData.append(FORM_FIELDS.asn, data.asn);
            formData.append(FORM_FIELDS.email, '');
            formData.append(FORM_FIELDS.data, JSON.stringify(data));
            formData.append(FORM_FIELDS.timestamp, data.timestamp);

            try {
                const iframe = document.createElement('iframe');
                iframe.name = 'hidden_iframe';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);

                const form = document.createElement('form');
                form.method = 'POST';
                form.action = GOOGLE_FORM_URL;
                form.target = 'hidden_iframe';

                for (const [key, value] of formData.entries()) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    form.appendChild(input);
                }

                document.body.appendChild(form);
                form.submit();

                setTimeout(() => {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                }, 1000);
            } catch (error) {
                console.error('Google Form submission error:', error);
            }
        }

        function downloadJSONBackup(data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AS${data.asn}_verification_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRR Link Verification Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .login-box {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 500px;
            margin: 100px auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .main-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #333; margin-bottom: 10px; font-size: 28px; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
        input[type="password"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .hidden { display: none; }
        .search-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .search-peer-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .search-results {
            margin-top: 15px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .search-result-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .search-result-item:hover { background: #e9ecef; }
        .search-match {
            background: #fff3cd !important;
            border-left: 4px solid #ffc107 !important;
            animation: highlight 0.5s ease;
        }
        @keyframes highlight {
            0% { background: #fff3cd; }
            50% { background: #ffe082; }
            100% { background: #fff3cd; }
        }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-box {
            flex: 1;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .stat-label { font-size: 12px; color: #666; text-transform: uppercase; }
        .stat-value { font-size: 24px; font-weight: bold; color: #333; }
        .country-group {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s;
        }
        .country-group:hover { border-color: #667eea; }
        .country-header {
            padding: 20px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .country-header:hover { background: #e9ecef; }
        .country-title { font-size: 18px; font-weight: bold; color: #333; }
        .country-count { color: #667eea; font-weight: bold; }
        .country-preview { font-size: 13px; color: #666; margin-top: 5px; }
        .country-actions {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: #fff;
            border-top: 1px solid #e0e0e0;
        }
        .country-actions button { flex: 1; padding: 10px; font-size: 14px; }
        .action-verify { background: #667eea; }
        .country-details {
            padding: 20px;
            background: #fff;
            border-top: 1px solid #e0e0e0;
        }
        .instruction-box {
            padding: 15px;
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1565C0;
        }
        .peer-verification-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        .peer-verification-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        .peer-info { flex: 1; }
        .peer-as { font-weight: bold; color: #333; margin-bottom: 4px; font-size: 15px; }
        .peer-org { font-size: 13px; color: #666; }
        .peer-actions { display: flex; gap: 10px; flex-shrink: 0; }
        .radio-group { display: flex; gap: 15px; }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .radio-option:hover { background: #e9ecef; }
        .radio-option input[type="radio"] { cursor: pointer; width: 18px; height: 18px; }
        .radio-option label { cursor: pointer; font-size: 14px; font-weight: 500; }
        .radio-active { color: #28a745; }
        .radio-obsolete { color: #dc3545; }
        .radio-unknown { color: #6c757d; }
        .pagination-controls {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        .pagination-controls p { margin-bottom: 10px; color: #666; font-size: 14px; }
        .pagination-controls button { background: #667eea; }
        .submit-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        .submit-btn {
            padding: 15px 40px;
            font-size: 18px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .error { color: #dc3545; margin-top: 10px; }
        .success { color: #28a745; margin-top: 10px; }
        .contact {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            color: #856404;
        }
        .verification-summary {
            margin-top: 20px;
            padding: 15px;
            background: #d4edda;
            border-radius: 8px;
            color: #155724;
        }
        .loading { text-align: center; padding: 20px; color: #667eea; font-size: 16px; }
        .progress-info {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
        }
        .clear-btn { background: #6c757d; }
        .large-as-warning {
            padding: 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="login-box">
            <h1>üîí Verification Portal</h1>
            <p class="subtitle">Enter password to continue</p>
            <input type="password" id="passwordInput" placeholder="Password" onkeypress="if(event.key==='Enter') login()">
            <button onclick="login()">Login</button>
            <p id="loginError" class="error hidden">Incorrect password</p>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="main-content hidden">
            <h1>IRR Link Verification</h1>
            <p class="subtitle">Verify IRR peering data for your AS</p>

            <!-- Search Section -->
            <div class="search-section">
                <h3 style="margin-bottom: 15px;">Find Your AS</h3>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="asnInput" placeholder="Enter AS number (e.g., 1234 or AS1234)" onkeypress="if(event.key==='Enter') searchAS()">
                    <button onclick="searchAS()">Search</button>
                </div>
                <div id="loadingMessage" class="loading hidden">Loading data...</div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <!-- Stats -->
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-label">Your AS</div>
                        <div class="stat-value" id="currentAS">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Total Peer Links</div>
                        <div class="stat-value" id="linkCount">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Peer Countries</div>
                        <div class="stat-value" id="countryCount">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Verified Peers</div>
                        <div class="stat-value" id="verifiedCount">0</div>
                    </div>
                </div>

                <!-- Large AS Warning -->
                <div id="largeAsWarning" class="large-as-warning hidden">
                    <strong>‚ö†Ô∏è Large AS Detected</strong><br>
                    This AS has many peer links. Peers are loaded in batches of 50 for better performance.
                </div>

                <!-- Peer Search Section -->
                <div class="search-peer-section">
                    <h3 style="margin-bottom: 10px;">üîç Find Specific Peer</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="peerSearchInput" placeholder="Search by AS number or name" style="flex: 1;" oninput="searchPeers()">
                        <button class="clear-btn" onclick="clearPeerSearch()">Clear</button>
                    </div>
                    <div id="searchResults" class="search-results hidden"></div>
                </div>

                <!-- Country Groups -->
                <div id="countryGroupsContainer"></div>

                <!-- Verification Summary -->
                <div id="verificationSummary" class="verification-summary hidden">
                    <h3>‚úì Verification Summary</h3>
                    <div id="summaryContent"></div>
                </div>

                <!-- Submit Section -->
                <div class="submit-section">
                    <button class="submit-btn" onclick="submitVerification()">Submit Verification</button>
                    <p class="subtitle" style="margin-top: 10px;">Data will be saved automatically</p>
                </div>
            </div>

            <div class="contact">
                <strong>Questions?</strong> Contact: usamaijaz404@gmail.com
            </div>
        </div>
    </div>

    <script>
        const PASSWORD_HASH = "deda38a7fa94cdc6863168750cac646efa25ff2e2a67babe979b46c3cb36b9ee";
        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfNAFdeWfeQ9RS-e2sQgysgGnPy75hl9BsJL3c-zMnXaC1yyA/formResponse";
        const FORM_FIELDS = {
            asn: "entry.1255619771",
            email: "entry.847494780",
            data: "entry.143108106",
            timestamp: "entry.969579197"
        };
        const PEERS_PER_PAGE = 50;
        const LARGE_AS_THRESHOLD = 1000;
        const MAX_SEARCH_RESULTS = 50;

        let countryIndex = {};
        let currentASN = '';
        let currentASData = null;
        let peerVerifications = {};
        let sessionHistory = [];
        let countryPages = {};

        async function login() {
            const password = document.getElementById('passwordInput').value;
            const hash = await sha256(password);
            if (hash === PASSWORD_HASH) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                loadCountryIndex();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function loadCountryIndex() {
            try {
                const response = await fetch('data/country_index.json');
                countryIndex = await response.json();
            } catch (error) {
                alert('Error loading data. Please contact support.');
            }
        }

        async function searchAS() {
            const input = document.getElementById('asnInput').value.trim();
            const asn = input.replace(/^AS/i, '');
            if (!asn) {
                alert('Please enter an AS number.');
                return;
            }
            const verifiedCount = Object.keys(peerVerifications).length;
            if (currentASN && verifiedCount > 0) {
                const proceed = confirm(`‚ö†Ô∏è Warning: You have ${verifiedCount} unsubmitted verification(s) for AS${currentASN}.\n\nSearching a new AS will lose this data.\n\nClick OK to continue anyway, or Cancel to go back and submit first.`);
                if (!proceed) return;
            }
            if (!countryIndex[asn]) {
                alert(`AS${asn} not found in our dataset.`);
                return;
            }
            currentASN = asn;
            peerVerifications = {};
            countryPages = {};
            document.getElementById('loadingMessage').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            const countryFile = countryIndex[asn].filename;
            try {
                const response = await fetch(`data/${countryFile}`);
                const countryData = await response.json();
                if (!countryData[asn]) {
                    alert(`AS${asn} not found in ${countryFile}.`);
                    return;
                }
                currentASData = countryData[asn];
                groupPeersByCountry();
                displayResults();
                document.getElementById('loadingMessage').classList.add('hidden');
            } catch (error) {
                alert('Error loading AS data. Please try again.');
                document.getElementById('loadingMessage').classList.add('hidden');
            }
        }

        function groupPeersByCountry() {
            const grouped = {};
            for (const link of currentASData.links) {
                const peerCountry = link.peer_country || 'Unknown';
                if (!grouped[peerCountry]) {
                    grouped[peerCountry] = { count: 0, peers: [] };
                }
                grouped[peerCountry].count++;
                grouped[peerCountry].peers.push(link);
            }
            const sortedGrouped = {};
            const sortedCountries = Object.keys(grouped).sort((a, b) => grouped[b].count - grouped[a].count);
            for (const country of sortedCountries) {
                sortedGrouped[country] = grouped[country];
                countryPages[country] = 0;
            }
            currentASData.grouped_by_country = sortedGrouped;
        }

        function displayResults() {
            const data = currentASData;
            const asInfo = data.as_info || {};
            const grouped = data.grouped_by_country || {};
            const asDisplay = asInfo.name && asInfo.name !== 'Unknown' ? `AS${currentASN} - ${asInfo.name} (${asInfo.country})` : `AS${currentASN}`;
            document.getElementById('currentAS').textContent = asDisplay;
            document.getElementById('linkCount').textContent = data.links.length;
            document.getElementById('countryCount').textContent = Object.keys(grouped).length;
            document.getElementById('verifiedCount').textContent = '0';
            if (data.links.length >= LARGE_AS_THRESHOLD) {
                document.getElementById('largeAsWarning').classList.remove('hidden');
            } else {
                document.getElementById('largeAsWarning').classList.add('hidden');
            }
            displayCountryGroups(grouped);
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function displayCountryGroups(grouped) {
            const container = document.getElementById('countryGroupsContainer');
            container.innerHTML = '';
            const countryFlags = {
                'Singapore': 'üá∏üá¨', 'United States': 'üá∫üá∏', 'Japan': 'üáØüáµ',
                'Indonesia': 'üáÆüá©', 'Australia': 'üá¶üá∫', 'Germany': 'üá©üá™',
                'United Kingdom': 'üá¨üáß', 'Netherlands': 'üá≥üá±', 'France': 'üá´üá∑',
                'China': 'üá®üá≥', 'India': 'üáÆüá≥', 'Malaysia': 'üá≤üáæ',
                'Thailand': 'üáπüá≠', 'South Korea': 'üá∞üá∑', 'Canada': 'üá®üá¶',
            };
            for (const [country, group] of Object.entries(grouped)) {
                const flag = countryFlags[country] || 'üåè';
                const countryDiv = createCountryGroup(country, group, flag);
                container.appendChild(countryDiv);
            }
        }

        function createCountryGroup(country, group, flag) {
            const div = document.createElement('div');
            div.className = 'country-group';
            div.id = `country-${country.replace(/\s+/g, '-')}`;
            const previewPeers = group.peers.slice(0, 3).map(p => p.peer_name).join(', ');
            const moreText = group.peers.length > 3 ? ` and ${group.peers.length - 3} more` : '';
            const peersToShow = group.peers.slice(0, PEERS_PER_PAGE);
            const hasMore = group.peers.length > PEERS_PER_PAGE;
            div.innerHTML = `
                <div class="country-header" onclick="toggleCountryDetails('${country}')">
                    <div>
                        <div class="country-title">${flag} ${country} <span class="country-count">(${group.count} peers)</span></div>
                        <div class="country-preview">${previewPeers}${moreText}</div>
                    </div>
                    <div>‚ñº</div>
                </div>
                <div class="country-actions">
                    <button class="action-verify" onclick="toggleCountryDetails('${country}', event)">üìã Verify Peers</button>
                </div>
                <div class="country-details hidden" id="details-${country.replace(/\s+/g, '-')}">
                    <div class="instruction-box">
                        <strong>Instructions:</strong> Review each peer and mark its current status.
                        Mark as <strong style="color: #28a745;">Active</strong> if peering relationship exists,
                        <strong style="color: #dc3545;">Obsolete</strong> if no longer peering, or
                        <strong style="color: #6c757d;">Unknown</strong> if you're not certain.
                    </div>
                    <div class="progress-info">Verified: <strong id="progress-${country.replace(/\s+/g, '-')}">0</strong> of ${group.count} peers</div>
                    <div class="peer-verification-list" id="peer-list-${country.replace(/\s+/g, '-')}">
                        ${peersToShow.map(peer => renderPeerItem(peer, country)).join('')}
                    </div>
                    ${hasMore ? `
                        <div class="pagination-controls" id="pagination-${country.replace(/\s+/g, '-')}">
                            <p>Showing ${PEERS_PER_PAGE} of ${group.count} peers</p>
                            <button onclick="loadMorePeers('${country}', event)">Load ${Math.min(PEERS_PER_PAGE, group.count - PEERS_PER_PAGE)} More Peers</button>
                        </div>
                    ` : ''}
                </div>
            `;
            return div;
        }

        function renderPeerItem(peer, country) {
            return `
                <div class="peer-verification-item" data-peer-as="${peer.peer_as}">
                    <div class="peer-info">
                        <div class="peer-as">AS${peer.peer_as} - ${peer.peer_name}</div>
                        <div class="peer-org">${peer.peer_org}</div>
                    </div>
                    <div class="peer-actions">
                        <div class="radio-group">
                            <div class="radio-option radio-active">
                                <input type="radio" name="peer-${peer.peer_as}" value="active" id="active-${peer.peer_as}" onchange="markPeer('${peer.peer_as}', 'active', '${country}')">
                                <label for="active-${peer.peer_as}">‚úì Active</label>
                            </div>
                            <div class="radio-option radio-obsolete">
                                <input type="radio" name="peer-${peer.peer_as}" value="obsolete" id="obsolete-${peer.peer_as}" onchange="markPeer('${peer.peer_as}', 'obsolete', '${country}')">
                                <label for="obsolete-${peer.peer_as}">‚úó Obsolete</label>
                            </div>
                            <div class="radio-option radio-unknown">
                                <input type="radio" name="peer-${peer.peer_as}" value="unknown" id="unknown-${peer.peer_as}" onchange="markPeer('${peer.peer_as}', 'unknown', '${country}')">
                                <label for="unknown-${peer.peer_as}">? Unknown</label>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadMorePeers(country, event) {
            event.stopPropagation();
            const group = currentASData.grouped_by_country[country];
            countryPages[country]++;
            const start = countryPages[country] * PEERS_PER_PAGE;
            const end = Math.min(start + PEERS_PER_PAGE, group.peers.length);
            const peersToShow = group.peers.slice(start, end);
            const listId = `peer-list-${country.replace(/\s+/g, '-')}`;
            const listEl = document.getElementById(listId);
            peersToShow.forEach(peer => {
                listEl.innerHTML += renderPeerItem(peer, country);
            });
            const paginationId = `pagination-${country.replace(/\s+/g, '-')}`;
            const paginationEl = document.getElementById(paginationId);
            const loaded = Math.min(end, group.peers.length);
            const remaining = group.peers.length - loaded;
            if (remaining > 0) {
                paginationEl.innerHTML = `<p>Showing ${loaded} of ${group.count} peers</p><button onclick="loadMorePeers('${country}', event)">Load ${Math.min(PEERS_PER_PAGE, remaining)} More Peers</button>`;
            } else {
                paginationEl.innerHTML = `<p>‚úì All ${group.count} peers loaded</p>`;
            }
        }

        function toggleCountryDetails(country, event) {
            if (event) event.stopPropagation();
            const detailsId = `details-${country.replace(/\s+/g, '-')}`;
            const details = document.getElementById(detailsId);
            details.classList.toggle('hidden');
        }

        function markPeer(peerAS, status, country) {
            peerVerifications[peerAS] = status;
            updateVerifiedCount();
            updateCountryProgress(country);
            showVerificationSummary();
        }

        function updateCountryProgress(country) {
            const progressId = `progress-${country.replace(/\s+/g, '-')}`;
            const progressEl = document.getElementById(progressId);
            if (progressEl) {
                const countryData = currentASData.grouped_by_country[country];
                const verified = countryData.peers.filter(p => peerVerifications.hasOwnProperty(p.peer_as)).length;
                progressEl.textContent = verified;
            }
        }

        function updateVerifiedCount() {
            const verified = Object.keys(peerVerifications).length;
            document.getElementById('verifiedCount').textContent = verified;
        }

        function showVerificationSummary() {
            const summary = document.getElementById('verificationSummary');
            const content = document.getElementById('summaryContent');
            if (Object.keys(peerVerifications).length === 0) {
                summary.classList.add('hidden');
                return;
            }
            const activeCount = Object.values(peerVerifications).filter(v => v === 'active').length;
            const obsoleteCount = Object.values(peerVerifications).filter(v => v === 'obsolete').length;
            const unknownCount = Object.values(peerVerifications).filter(v => v === 'unknown').length;
            let html = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">';
            html += `<div><strong>Active:</strong> ${activeCount} peers</div>`;
            html += `<div><strong>Obsolete:</strong> ${obsoleteCount} peers</div>`;
            html += `<div><strong>Unknown:</strong> ${unknownCount} peers</div>`;
            html += '</div>';
            content.innerHTML = html;
            summary.classList.remove('hidden');
        }

        function searchPeers() {
            const searchTerm = document.getElementById('peerSearchInput').value.toLowerCase().trim();
            const resultsDiv = document.getElementById('searchResults');
            if (!searchTerm) {
                resultsDiv.classList.add('hidden');
                clearHighlights();
                return;
            }
            const cleanSearch = searchTerm.replace(/^as/i, '');
            const allMatches = [];
            const grouped = currentASData.grouped_by_country;
            for (const [country, group] of Object.entries(grouped)) {
                const countryMatches = group.peers.filter(peer => {
                    const asMatch = peer.peer_as.includes(cleanSearch);
                    const nameMatch = peer.peer_name.toLowerCase().includes(searchTerm);
                    const orgMatch = peer.peer_org.toLowerCase().includes(searchTerm);
                    return asMatch || nameMatch || orgMatch;
                });
                if (countryMatches.length > 0) {
                    allMatches.push({ country: country, peers: countryMatches, count: countryMatches.length });
                }
            }
            const totalMatches = allMatches.reduce((sum, m) => sum + m.count, 0);
            if (totalMatches === 0) {
                resultsDiv.innerHTML = '<p style="color: #666;">No peers found matching "' + searchTerm + '"</p>';
                resultsDiv.classList.remove('hidden');
                clearHighlights();
                return;
            }
            let displayedCount = 0;
            const matchesToShow = [];
            for (const match of allMatches) {
                if (displayedCount >= MAX_SEARCH_RESULTS) break;
                const peersToShow = match.peers.slice(0, MAX_SEARCH_RESULTS - displayedCount);
                matchesToShow.push({ country: match.country, peers: peersToShow, count: peersToShow.length });
                displayedCount += peersToShow.length;
            }
            let html = '<strong>Found ' + totalMatches + ' peer(s)</strong>';
            if (totalMatches > MAX_SEARCH_RESULTS) {
                html += ` <span style="color: #dc3545;">(showing first ${MAX_SEARCH_RESULTS})</span><br><small style="color: #856404;">üí° Refine your search to see specific peers</small>`;
            }
            html += '<br><br>';
            matchesToShow.forEach(match => {
                html += `<div class="search-result-item" onclick="jumpToPeer('${match.country}', '${match.peers[0].peer_as}')"><strong>${getCountryFlag(match.country)} ${match.country}</strong>: ${match.count} match(es)<br><small style="color: #666;">${match.peers.map(p => 'AS' + p.peer_as + ' - ' + p.peer_name).join(', ')}</small></div>`;
            });
            resultsDiv.innerHTML = html;
            resultsDiv.classList.remove('hidden');
            highlightMatches(matchesToShow);
        }

        function jumpToPeer(country, peerAS) {
            const detailsId = `details-${country.replace(/\s+/g, '-')}`;
            const details = document.getElementById(detailsId);
            details.classList.remove('hidden');
            const group = currentASData.grouped_by_country[country];
            const peerIndex = group.peers.findIndex(p => p.peer_as === peerAS);
            const currentPage = countryPages[country] || 0;
            const peersLoaded = (currentPage + 1) * PEERS_PER_PAGE;
            while (peerIndex >= peersLoaded && peersLoaded < group.peers.length) {
                loadMorePeers(country, { stopPropagation: () => {} });
            }
            const countryDiv = document.getElementById(`country-${country.replace(/\s+/g, '-')}`);
            countryDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            setTimeout(() => {
                const peerItems = countryDiv.querySelectorAll('.peer-verification-item');
                peerItems.forEach(item => {
                    if (item.getAttribute('data-peer-as') === peerAS) {
                        item.classList.add('search-match');
                        item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }, 500);
        }

        function highlightMatches(matches) {
            clearHighlights();
            matches.forEach(match => {
                const detailsId = `details-${match.country.replace(/\s+/g, '-')}`;
                const details = document.getElementById(detailsId);
                if (details) details.classList.remove('hidden');
                const countryDiv = document.getElementById(`country-${match.country.replace(/\s+/g, '-')}`);
                if (countryDiv) {
                    const peerItems = countryDiv.querySelectorAll('.peer-verification-item');
                    peerItems.forEach(item => {
                        match.peers.forEach(peer => {
                            if (item.getAttribute('data-peer-as') === peer.peer_as) {
                                item.classList.add('search-match');
                            }
                        });
                    });
                }
            });
        }

        function clearHighlights() {
            document.querySelectorAll('.search-match').forEach(el => {
                el.classList.remove('search-match');
            });
        }

        function clearPeerSearch() {
            document.getElementById('peerSearchInput').value = '';
            document.getElementById('searchResults').classList.add('hidden');
            clearHighlights();
        }

        function getCountryFlag(country) {
            const flags = {
                'Singapore': 'üá∏üá¨', 'United States': 'üá∫üá∏', 'Japan': 'üáØüáµ',
                'Indonesia': 'üáÆüá©', 'Australia': 'üá¶üá∫', 'Germany': 'üá©üá™',
                'United Kingdom': 'üá¨üáß', 'Netherlands': 'üá≥üá±', 'France': 'üá´üá∑',
                'China': 'üá®üá≥', 'India': 'üáÆüá≥', 'Malaysia': 'üá≤üáæ',
                'Thailand': 'üáπüá≠', 'South Korea': 'üá∞üá∑', 'Canada': 'üá®üá¶',
            };
            return flags[country] || 'üåè';
        }

        function resetForNewAS() {
            currentASN = '';
            currentASData = null;
            peerVerifications = {};
            countryPages = {};
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('asnInput').value = '';
            document.getElementById('asnInput').focus();
            clearPeerSearch();
            document.querySelector('.search-section').scrollIntoView({ behavior: 'smooth' });
        }

        function showSessionSummary() {
            if (sessionHistory.length === 0) return;
            let summary = `‚úì Session Complete!\n\nYou verified ${sessionHistory.length} AS${sessionHistory.length > 1 ? 'es' : ''}:\n\n`;
            sessionHistory.forEach(entry => {
                summary += `‚úì AS${entry.asn}: ${entry.verified_count} peer${entry.verified_count > 1 ? 's' : ''}\n`;
            });
            summary += `\nThank you for your contribution!`;
            alert(summary);
        }

        async function submitVerification() {
            if (Object.keys(peerVerifications).length === 0) {
                alert('Please verify at least one peer before submitting.');
                return;
            }
            const data = {
                asn: currentASN,
                as_info: currentASData.as_info,
                peer_verifications: peerVerifications,
                timestamp: new Date().toISOString(),
                total_peers: currentASData.links.length,
                verified_peers: Object.keys(peerVerifications).length,
                summary: {
                    active: Object.values(peerVerifications).filter(v => v === 'active').length,
                    obsolete: Object.values(peerVerifications).filter(v => v === 'obsolete').length,
                    unknown: Object.values(peerVerifications).filter(v => v === 'unknown').length
                }
            };

            // Download JSON for operator
            downloadJSONBackup(data);

            // Send to researcher automatically
            await sendToResearcher(data);

            // Also submit to Google Form
            await submitToGoogleForm(data);

            sessionHistory.push({
                asn: currentASN,
                verified_count: Object.keys(peerVerifications).length,
                timestamp: data.timestamp
            });

            const continueVerifying = confirm(
                `‚úì AS${currentASN} verification submitted successfully!\n\n` +
                `Verified: ${Object.keys(peerVerifications).length} peers\n\n` +
                `Data saved automatically.\n\n` +
                `Verify another AS?`
            );

            if (continueVerifying) {
                resetForNewAS();
            } else {
                showSessionSummary();
            }
        }

        async function submitToGoogleForm(data) {
            const formData = new FormData();
            formData.append(FORM_FIELDS.asn, data.asn);
            formData.append(FORM_FIELDS.email, '');
            formData.append(FORM_FIELDS.data, JSON.stringify(data));
            formData.append(FORM_FIELDS.timestamp, data.timestamp);
            try {
                const iframe = document.createElement('iframe');
                iframe.name = 'hidden_iframe';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = GOOGLE_FORM_URL;
                form.target = 'hidden_iframe';
                for (const [key, value] of formData.entries()) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    form.appendChild(input);
                }
                document.body.appendChild(form);
                form.submit();
                setTimeout(() => {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                }, 1000);
            } catch (error) {
                console.error('Google Form submission error:', error);
            }
        }

        async function sendToResearcher(data) {
            try {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'https://formsubmit.co/usamaijaz404@gmail.com';
                form.target = '_blank';

                const subjectInput = document.createElement('input');
                subjectInput.type = 'hidden';
                subjectInput.name = '_subject';
                subjectInput.value = `AS${data.asn} IRR Verification`;
                form.appendChild(subjectInput);

                const dataInput = document.createElement('input');
                dataInput.type = 'hidden';
                dataInput.name = 'data';
                dataInput.value = JSON.stringify(data, null, 2);
                form.appendChild(dataInput);

                const captchaInput = document.createElement('input');
                captchaInput.type = 'hidden';
                captchaInput.name = '_captcha';
                captchaInput.value = 'false';
                form.appendChild(captchaInput);

                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
            } catch (error) {
                console.error('Email send error:', error);
            }
        }

        function downloadJSONBackup(data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AS${data.asn}_verification_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
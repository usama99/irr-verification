<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRR Link Verification Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .login-box {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 500px;
            margin: 100px auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .main-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #333; margin-bottom: 10px; font-size: 28px; }
        h2 { color: #333; margin-bottom: 10px; font-size: 24px; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
        input[type="password"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .hidden { display: none; }
        .search-peer-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .search-results {
            margin-top: 15px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            max-height: 400px;
            overflow-y: auto;
        }
        .search-result-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .search-result-item:hover { background: #e9ecef; }
        .search-match {
            background: #fff3cd !important;
            border-left: 4px solid #ffc107 !important;
            animation: highlight 0.5s ease;
        }
        @keyframes highlight {
            0% { background: #fff3cd; }
            50% { background: #ffe082; }
            100% { background: #fff3cd; }
        }
        .clear-btn { background: #6c757d; }
        .large-as-warning {
            padding: 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #856404;
        }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-box {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .stat-label { font-size: 12px; color: #666; text-transform: uppercase; }
        .stat-value { font-size: 24px; font-weight: bold; color: #333; }
        .country-group {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s;
        }
        .country-group:hover { border-color: #667eea; }
        .country-header {
            padding: 20px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .country-header:hover { background: #e9ecef; }
        .country-title { font-size: 18px; font-weight: bold; color: #333; }
        .country-count { color: #667eea; font-weight: bold; }
        .country-preview { font-size: 13px; color: #666; margin-top: 5px; }
        .country-details {
            padding: 20px;
            background: #fff;
            border-top: 1px solid #e0e0e0;
        }

        /* AS CLASS GROUP STYLES */
        .as-class-group {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .as-class-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .as-class-header:hover { background: #e9ecef; }
        .as-class-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .as-class-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            color: white;
        }
        .as-class-Tier1 .as-class-badge { background: #dc3545; }
        .as-class-Hypergiant .as-class-badge { background: #fd7e14; }
        .as-class-Largenetworks .as-class-badge { background: #ffc107; color: #333; }
        .as-class-Mediumnetworks .as-class-badge { background: #0dcaf0; }
        .as-class-Smallnetworks .as-class-badge { background: #6c757d; }
        .as-class-count {
            font-size: 14px;
            color: #666;
            font-weight: normal;
        }
        .as-class-details {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }
        .unclassified-info {
            padding: 12px;
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #856404;
        }

        .instruction-box {
            padding: 15px;
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1565C0;
        }
        .peer-verification-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        .peer-verification-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            flex-wrap: wrap;
            gap: 10px;
        }
        .peer-info { flex: 1; min-width: 200px; }
        .peer-as { font-weight: bold; color: #333; margin-bottom: 4px; font-size: 15px; }
        .peer-org { font-size: 13px; color: #666; }
        .peer-actions { display: flex; gap: 10px; flex-shrink: 0; }
        .radio-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .radio-option:hover { background: #e9ecef; }
        .radio-option input[type="radio"] { cursor: pointer; width: 18px; height: 18px; }
        .radio-option label { cursor: pointer; font-size: 14px; font-weight: 500; white-space: nowrap; }
        .radio-active { color: #28a745; }
        .radio-obsolete { color: #dc3545; }
        .radio-unknown { color: #6c757d; }
        .pagination-controls {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        .pagination-controls p { margin-bottom: 10px; color: #666; font-size: 14px; }
        .pagination-controls button { background: #667eea; }
        .submit-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        .submit-btn {
            padding: 15px 40px;
            font-size: 18px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .error { color: #dc3545; margin-top: 10px; }
        .success { color: #28a745; margin-top: 10px; }
        .contact {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            color: #856404;
        }
        .verification-summary {
            margin-top: 20px;
            padding: 15px;
            background: #d4edda;
            border-radius: 8px;
            color: #155724;
        }
        .loading { text-align: center; padding: 20px; color: #667eea; font-size: 16px; }
        .progress-info {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
        }
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .success-modal {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: slideUp 0.4s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 50px;
        }
        .success-title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .success-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .success-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success-stat-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 15px;
        }
        .success-stat-label { color: #666; }
        .success-stat-value { font-weight: bold; color: #333; }
        .success-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .success-btn-primary {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- LOGIN SECTION -->
        <div id="loginSection" class="login-box">
            <h2>üîí IRR Links Verification Portal</h2>
            <p class="subtitle">Enter your credentials</p>
            <input type="text" id="asnInput" placeholder="AS Number (e.g., 10 or AS10)" onkeypress="if(event.key==='Enter') document.getElementById('passwordInput').focus()">
            <input type="password" id="passwordInput" placeholder="Password" onkeypress="if(event.key==='Enter') login()">
            <button onclick="login()">Login</button>
            <p id="loginError" class="error hidden">Invalid AS number or password</p>
            <div id="loginLoading" class="loading hidden">Loading your data...</div>
        </div>

        <!-- MAIN CONTENT SECTION -->
        <div id="mainContent" class="main-content hidden">
            <h1>IRR Link Verification</h1>
            <p class="subtitle">Verify IRR peering data for your AS - Organized by Country & AS Class</p>

            <div class="stats">
                <div class="stat-box"><div class="stat-label">Your AS</div><div class="stat-value" id="currentAS">-</div></div>
                <div class="stat-box"><div class="stat-label">Total Peer Links</div><div class="stat-value" id="linkCount">-</div></div>
                <div class="stat-box"><div class="stat-label">Peer Countries</div><div class="stat-value" id="countryCount">-</div></div>
                <div class="stat-box"><div class="stat-label">Verified Peers</div><div class="stat-value" id="verifiedCount">0</div></div>
            </div>

            <div id="largeAsWarning" class="large-as-warning hidden">
                <strong>‚ö†Ô∏è Large AS Detected</strong><br>
                Peers are organized by country and AS classification (Tier1, Hypergiant, Large, Medium, Small) to help you prioritize verification.
            </div>

            <!-- PEER SEARCH SECTION -->
            <div class="search-peer-section">
                <h3 style="margin-bottom: 10px;">üîç Search Peer Links</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="peerSearchInput" placeholder="AS number ‚Ä¢ Organization name ‚Ä¢ Network name" style="flex: 1;" oninput="searchPeers()">
                    <button class="clear-btn" onclick="clearPeerSearch()">Clear</button>
                </div>
                <div id="searchResults" class="search-results hidden"></div>
            </div>

            <div id="countryGroupsContainer"></div>

            <div id="verificationSummary" class="verification-summary hidden">
                <h3>‚úì Verification Summary</h3>
                <div id="summaryContent"></div>
            </div>

            <div class="submit-section">
                <button class="submit-btn" onclick="submitVerification()">Submit Verification</button>
                <p class="subtitle" style="margin-top: 10px;">Data will be saved automatically</p>
            </div>

            <div class="contact">For questions or technical issues, please contact: <strong><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="c6b3b5a7aba7a3aca7bcf2f6f286a1aba7afaae8a5a9ab">[email&#160;protected]</a></strong></div>
        </div>
    </div>

    <!-- Fuse.js -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

    <script>
        // ====================================================================
        // GLOBAL VARIABLES
        // ====================================================================
        let CREDENTIALS = {};
        let countryIndex = {};
        let currentASN = '';
        let currentASData = null;
        let peerVerifications = {};
        let asClassPages = {};
        let searchIndex = null;
        let searchDebounceTimer = null;

        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfNAFdeWfeQ9RS-e2sQgysgGnPy75hl9BsJL3c-zMnXaC1yyA/formResponse";
        const FORM_FIELDS = {
            asn: "entry.1255619771",
            email: "entry.847494780",
            data: "entry.143108106",
            timestamp: "entry.969579197"
        };
        const PEERS_PER_PAGE = 50;
        const LARGE_AS_THRESHOLD = 1000;
        const MAX_SEARCH_RESULTS = 50;

        // AS Class display order (excludes Unknown)
        const AS_CLASS_ORDER = [
            'Tier1',
            'Hypergiant',
            'Large networks',
            'Medium networks',
            'Small networks'
        ];

        const AS_CLASS_LABELS = {
            'Tier1': 'üî¥ TIER 1',
            'Hypergiant': 'üü† HYPERGIANT',
            'Large networks': 'üü° LARGE',
            'Medium networks': 'üîµ MEDIUM',
            'Small networks': '‚ö™ SMALL'
        };

        // ====================================================================
        // INITIALIZE
        // ====================================================================
        async function initialize() {
            try {
                // Load credentials
                const credResponse = await fetch('credentials.json');
                if (!credResponse.ok) {
                    throw new Error('Failed to load credentials file');
                }
                CREDENTIALS = await credResponse.json();

                // Load country index
                const indexResponse = await fetch('data/country_index.json');
                if (!indexResponse.ok) {
                    throw new Error('Failed to load country index file');
                }
                countryIndex = await indexResponse.json();

                console.log('‚úì Portal initialized successfully');
            } catch (error) {
                console.error('Fatal: Error loading portal data:', error);
                alert('Error loading portal configuration. Please contact support.\n\nError: ' + error.message);
            }
        }

        initialize();

        // ====================================================================
        // SHA-256 HASH
        // ====================================================================
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // ====================================================================
        // LOGIN
        // ====================================================================
        async function login() {
            const asnInput = document.getElementById('asnInput').value.trim().replace(/^AS/i, '');
            const password = document.getElementById('passwordInput').value;

            if (!asnInput || !password) {
                document.getElementById('loginError').textContent = 'Please enter both AS number and password';
                document.getElementById('loginError').classList.remove('hidden');
                return;
            }

            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('loginLoading').classList.remove('hidden');

            try {
                // Check credentials exist
                if (!CREDENTIALS[asnInput]) {
                    throw new Error('INVALID_CREDENTIALS');
                }

                // Verify password
                const passwordHash = await sha256(password);
                if (passwordHash !== CREDENTIALS[asnInput]) {
                    throw new Error('INVALID_CREDENTIALS');
                }

                // Load AS data (will throw error if fails)
                currentASN = asnInput;
                await loadASData(asnInput);

                // Only show main content if everything succeeded
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

            } catch (error) {
                console.error('Login error:', error);

                // Show appropriate error message
                let errorMessage = 'An error occurred. Please try again.';

                if (error.message === 'INVALID_CREDENTIALS') {
                    errorMessage = 'Invalid AS number or password';
                } else if (error.message.includes('not found in index')) {
                    errorMessage = 'AS data not available. Please contact support.';
                } else if (error.message.includes('Failed to load data file')) {
                    errorMessage = 'Error loading AS data. Please contact support.';
                } else if (error.message.includes('not found in file')) {
                    errorMessage = 'AS data corrupted. Please contact support.';
                } else {
                    errorMessage = 'Error loading data. Please contact support.';
                }

                document.getElementById('loginError').textContent = errorMessage;
                document.getElementById('loginError').classList.remove('hidden');

                // Reset state
                currentASN = '';
                currentASData = null;
            } finally {
                document.getElementById('loginLoading').classList.add('hidden');
            }
        }

        // ====================================================================
        // LOAD AS DATA
        // ====================================================================
        async function loadASData(asn) {
            if (!countryIndex[asn]) {
                throw new Error('AS not found in index');
            }

            const countryFile = countryIndex[asn].filename;

            let response;
            try {
                response = await fetch(`data/${countryFile}`);
            } catch (error) {
                throw new Error(`Network error loading data file: ${error.message}`);
            }

            if (!response.ok) {
                throw new Error(`Failed to load data file (HTTP ${response.status})`);
            }

            let countryData;
            try {
                countryData = await response.json();
            } catch (error) {
                throw new Error(`Invalid JSON in data file: ${error.message}`);
            }

            if (!countryData[asn]) {
                throw new Error('AS data not found in file');
            }

            currentASData = countryData[asn];

            // Validate data structure
            if (!currentASData.links || !Array.isArray(currentASData.links)) {
                throw new Error('Invalid data structure: missing links array');
            }

            if (!currentASData.grouped_by_country || typeof currentASData.grouped_by_country !== 'object') {
                throw new Error('Invalid data structure: missing grouped_by_country');
            }

            // Initialize pagination for AS classes
            for (const country of Object.keys(currentASData.grouped_by_country)) {
                asClassPages[country] = {};
                const countryData = currentASData.grouped_by_country[country];
                if (countryData.grouped_by_as_class) {
                    for (const asClass of Object.keys(countryData.grouped_by_as_class)) {
                        asClassPages[country][asClass] = 0;
                    }
                }
            }

            buildSearchIndex();
            displayResults();
        }

        // ====================================================================
        // BUILD SEARCH INDEX
        // ====================================================================
        function buildSearchIndex() {
            const searchData = [];

            for (const [country, group] of Object.entries(currentASData.grouped_by_country)) {
                group.peers.forEach(peer => {
                    searchData.push({
                        peer_as: peer.peer_as.toString().replace(/^AS/i, ''),
                        peer_name: peer.peer_name,
                        peer_org: peer.peer_org,
                        peer_as_class: peer.peer_as_class || 'Unknown',
                        country: country
                    });
                });
            }

            const options = {
                keys: [
                    { name: 'peer_as', weight: 2.0 },
                    { name: 'peer_name', weight: 1.0 },
                    { name: 'peer_org', weight: 1.0 }
                ],
                threshold: 0.4,
                ignoreLocation: true,
                minMatchCharLength: 1,
                includeScore: true
            };

            searchIndex = new Fuse(searchData, options);
        }

        // ====================================================================
        // DISPLAY RESULTS
        // ====================================================================
        function displayResults() {
            const data = currentASData;
            const asInfo = data.as_info || {};
            const grouped = data.grouped_by_country || {};

            const asDisplay = asInfo.name && asInfo.name !== 'Unknown'
                ? `AS${currentASN} - ${asInfo.name} (${asInfo.country})`
                : `AS${currentASN}`;

            document.getElementById('currentAS').textContent = asDisplay;
            document.getElementById('linkCount').textContent = data.links.length;
            document.getElementById('countryCount').textContent = Object.keys(grouped).length;
            document.getElementById('verifiedCount').textContent = '0';

            if (data.links.length >= LARGE_AS_THRESHOLD) {
                document.getElementById('largeAsWarning').classList.remove('hidden');
            }

            displayCountryGroups(grouped);
        }

        // ====================================================================
        // DISPLAY COUNTRY GROUPS
        // ====================================================================
        function displayCountryGroups(grouped) {
            const container = document.getElementById('countryGroupsContainer');
            container.innerHTML = '';

            const countryFlags = {
                'Singapore': 'üá∏üá¨', 'United States': 'üá∫üá∏', 'Japan': 'üáØüáµ',
                'Indonesia': 'üáÆüá©', 'Australia': 'üá¶üá∫', 'Germany': 'üá©üá™',
                'United Kingdom': 'üá¨üáß', 'Netherlands': 'üá≥üá±', 'France': 'üá´üá∑',
                'China': 'üá®üá≥', 'India': 'üáÆüá≥', 'Malaysia': 'üá≤üáæ',
                'Thailand': 'üáπüá≠', 'South Korea': 'üá∞üá∑', 'Canada': 'üá®üá¶',
            };

            for (const [country, group] of Object.entries(grouped)) {
                const flag = countryFlags[country] || 'üåè';
                const countryDiv = createCountryGroup(country, group, flag);
                container.appendChild(countryDiv);
            }
        }

        // ====================================================================
        // CREATE COUNTRY GROUP
        // ====================================================================
        function createCountryGroup(country, group, flag) {
            const div = document.createElement('div');
            div.className = 'country-group';
            div.id = `country-${country.replace(/\s+/g, '-')}`;

            const previewPeers = group.peers.slice(0, 3).map(p => p.peer_name).join(', ');
            const moreText = group.peers.length > 3 ? ` and ${group.peers.length - 3} more` : '';

            const hasASClassGrouping = group.grouped_by_as_class && Object.keys(group.grouped_by_as_class).length > 0;

            let detailsHTML = '';

            if (hasASClassGrouping) {
                detailsHTML = `
                    <div class="instruction-box">
                        <strong>üìä AS Classifications:</strong> Peers are grouped by network size (Tier1 ‚Üí Hypergiant ‚Üí Large ‚Üí Medium ‚Üí Small).
                        Verify critical Tier1 relationships first!
                    </div>
                    <div class="progress-info">Verified: <strong id="progress-${country.replace(/\s+/g, '-')}">0</strong> of ${group.count} peers</div>
                    ${createASClassGroups(country, group)}
                `;
            } else {
                const peersToShow = group.peers.slice(0, PEERS_PER_PAGE);

                detailsHTML = `
                    <div class="instruction-box">
                        <strong>Instructions:</strong> Review each peer and mark its current status.
                    </div>
                    <div class="progress-info">Verified: <strong id="progress-${country.replace(/\s+/g, '-')}">0</strong> of ${group.count} peers</div>
                    <div class="peer-verification-list">
                        ${peersToShow.map(peer => renderPeerItem(peer)).join('')}
                    </div>
                `;
            }

            div.innerHTML = `
                <div class="country-header" onclick="toggleCountryDetails('${country}')">
                    <div>
                        <div class="country-title">${flag} ${country} <span class="country-count">(${group.count} peers)</span></div>
                        <div class="country-preview">${previewPeers}${moreText}</div>
                    </div>
                    <div>‚ñº</div>
                </div>
                <div class="country-details hidden" id="details-${country.replace(/\s+/g, '-')}">
                    ${detailsHTML}
                </div>
            `;
            return div;
        }

        // ====================================================================
        // CREATE AS CLASS GROUPS
        // ====================================================================
        function createASClassGroups(country, countryData) {
            let html = '';

            const asClassGroups = countryData.grouped_by_as_class || {};
            const unclassifiedCount = countryData.unclassified_count || 0;

            if (unclassifiedCount > 0) {
                html += `
                    <div class="unclassified-info">
                        ‚ÑπÔ∏è ${unclassifiedCount} peer(s) could not be classified (included in total count above).
                    </div>
                `;
            }

            for (const asClass of AS_CLASS_ORDER) {
                if (!asClassGroups[asClass]) continue;

                const classData = asClassGroups[asClass];
                const peersToShow = classData.peers.slice(0, PEERS_PER_PAGE);
                const hasMore = classData.peers.length > PEERS_PER_PAGE;

                const classKey = asClass.replace(/\s+/g, '');
                const groupId = `${country.replace(/\s+/g, '-')}-${classKey}`;

                html += `
                    <div class="as-class-group as-class-${classKey}">
                        <div class="as-class-header" onclick="toggleASClassDetails('${country}', '${asClass}')">
                            <div class="as-class-title">
                                <span class="as-class-badge">${AS_CLASS_LABELS[asClass]}</span>
                                <span class="as-class-count">${classData.count} peers</span>
                            </div>
                            <div>‚ñº</div>
                        </div>
                        <div class="as-class-details hidden" id="details-${groupId}">
                            <div class="peer-verification-list" id="peer-list-${groupId}">
                                ${peersToShow.map(peer => renderPeerItem(peer)).join('')}
                            </div>
                            ${hasMore ? `
                                <div class="pagination-controls" id="pagination-${groupId}">
                                    <p>Showing ${PEERS_PER_PAGE} of ${classData.count} peers</p>
                                    <button onclick="loadMorePeersASClass('${country}', '${asClass}', event)">Load ${Math.min(PEERS_PER_PAGE, classData.peers.length - PEERS_PER_PAGE)} More</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            return html;
        }

        // ====================================================================
        // TOGGLE AS CLASS DETAILS
        // ====================================================================
        function toggleASClassDetails(country, asClass) {
            const classKey = asClass.replace(/\s+/g, '');
            const groupId = `${country.replace(/\s+/g, '-')}-${classKey}`;
            const details = document.getElementById(`details-${groupId}`);
            details.classList.toggle('hidden');
        }

        // ====================================================================
        // LOAD MORE PEERS (AS CLASS)
        // ====================================================================
        function loadMorePeersASClass(country, asClass, event) {
            event.stopPropagation();

            const classData = currentASData.grouped_by_country[country].grouped_by_as_class[asClass];

            if (!asClassPages[country]) asClassPages[country] = {};
            if (!asClassPages[country][asClass]) asClassPages[country][asClass] = 0;

            asClassPages[country][asClass]++;

            const start = asClassPages[country][asClass] * PEERS_PER_PAGE;
            const end = Math.min(start + PEERS_PER_PAGE, classData.peers.length);
            const peersToShow = classData.peers.slice(start, end);

            const classKey = asClass.replace(/\s+/g, '');
            const groupId = `${country.replace(/\s+/g, '-')}-${classKey}`;
            const listEl = document.getElementById(`peer-list-${groupId}`);

            peersToShow.forEach(peer => {
                listEl.innerHTML += renderPeerItem(peer);
            });

            const paginationEl = document.getElementById(`pagination-${groupId}`);
            const loaded = Math.min(end, classData.peers.length);
            const remaining = classData.peers.length - loaded;

            if (remaining > 0) {
                paginationEl.innerHTML = `
                    <p>Showing ${loaded} of ${classData.count} peers</p>
                    <button onclick="loadMorePeersASClass('${country}', '${asClass}', event)">Load ${Math.min(PEERS_PER_PAGE, remaining)} More</button>
                `;
            } else {
                paginationEl.innerHTML = `<p>‚úì All ${classData.count} peers loaded</p>`;
            }
        }

        // ====================================================================
        // RENDER PEER ITEM
        // ====================================================================
        function renderPeerItem(peer) {
            return `
                <div class="peer-verification-item" data-peer-as="${peer.peer_as}">
                    <div class="peer-info">
                        <div class="peer-as">AS${peer.peer_as} - ${peer.peer_name}</div>
                        <div class="peer-org">${peer.peer_org}</div>
                    </div>
                    <div class="peer-actions">
                        <div class="radio-group">
                            <div class="radio-option radio-active">
                                <input type="radio" name="peer-${peer.peer_as}" value="active" id="active-${peer.peer_as}" onchange="markPeer('${peer.peer_as}')">
                                <label for="active-${peer.peer_as}">‚úì Active</label>
                            </div>
                            <div class="radio-option radio-obsolete">
                                <input type="radio" name="peer-${peer.peer_as}" value="obsolete" id="obsolete-${peer.peer_as}" onchange="markPeer('${peer.peer_as}')">
                                <label for="obsolete-${peer.peer_as}">‚úó Obsolete</label>
                            </div>
                            <div class="radio-option radio-unknown">
                                <input type="radio" name="peer-${peer.peer_as}" value="unknown" id="unknown-${peer.peer_as}" onchange="markPeer('${peer.peer_as}')">
                                <label for="unknown-${peer.peer_as}">? Unknown</label>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ====================================================================
        // SEARCH PEERS
        // ====================================================================
        function searchPeers() {
            clearTimeout(searchDebounceTimer);

            const searchTerm = document.getElementById('peerSearchInput').value.trim();
            const resultsDiv = document.getElementById('searchResults');

            if (!searchTerm || searchTerm.length < 1) {
                resultsDiv.classList.add('hidden');
                clearHighlights();
                return;
            }

            searchDebounceTimer = setTimeout(() => {
                performSearch(searchTerm, resultsDiv);
            }, 150);
        }

        function performSearch(searchTerm, resultsDiv) {
            const cleanSearchTerm = searchTerm.replace(/^AS/i, '').trim();
            let results = [];

            if (/^\d+$/.test(cleanSearchTerm)) {
                results = searchIndex.search(cleanSearchTerm);
            } else {
                results = searchIndex.search(searchTerm);
            }

            if (results.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #666;">No peers found</p>';
                resultsDiv.classList.remove('hidden');
                clearHighlights();
                return;
            }

            const groupedResults = {};
            results.slice(0, MAX_SEARCH_RESULTS).forEach(result => {
                const peer = result.item;
                if (!groupedResults[peer.country]) {
                    groupedResults[peer.country] = [];
                }
                groupedResults[peer.country].push(peer);
            });

            let html = `<strong>Found ${results.length} peer(s)</strong><br><br>`;

            for (const [country, peers] of Object.entries(groupedResults)) {
                html += `<div class="search-result-item" onclick="jumpToPeer('${country}', '${peers[0].peer_as}', '${peers[0].peer_as_class}')">
                    <strong>${getCountryFlag(country)} ${country}</strong>: ${peers.length} match(es)<br>
                    <small style="color: #666;">${peers.map(p => 'AS' + p.peer_as).join(', ')}</small>
                </div>`;
            }

            resultsDiv.innerHTML = html;
            resultsDiv.classList.remove('hidden');
        }

        // ====================================================================
        // JUMP TO PEER
        // ====================================================================
        function jumpToPeer(country, peerAS, asClass) {
            const countryDetails = document.getElementById(`details-${country.replace(/\s+/g, '-')}`);
            countryDetails.classList.remove('hidden');

            if (asClass && asClass !== 'Unknown' && AS_CLASS_ORDER.includes(asClass)) {
                const classKey = asClass.replace(/\s+/g, '');
                const groupId = `${country.replace(/\s+/g, '-')}-${classKey}`;
                const asClassDetails = document.getElementById(`details-${groupId}`);
                if (asClassDetails) {
                    asClassDetails.classList.remove('hidden');
                }
            }

            const countryDiv = document.getElementById(`country-${country.replace(/\s+/g, '-')}`);
            countryDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

            setTimeout(() => {
                const peerItems = document.querySelectorAll('.peer-verification-item');
                peerItems.forEach(item => {
                    if (item.getAttribute('data-peer-as') == peerAS) {
                        item.classList.add('search-match');
                        item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }, 500);
        }

        // ====================================================================
        // HELPERS
        // ====================================================================
        function clearHighlights() {
            document.querySelectorAll('.search-match').forEach(el => {
                el.classList.remove('search-match');
            });
        }

        function clearPeerSearch() {
            document.getElementById('peerSearchInput').value = '';
            document.getElementById('searchResults').classList.add('hidden');
            clearHighlights();
        }

        function getCountryFlag(country) {
            const flags = {
                'Singapore': 'üá∏üá¨', 'United States': 'üá∫üá∏', 'Japan': 'üáØüáµ',
                'Indonesia': 'üáÆüá©', 'Australia': 'üá¶üá∫', 'Germany': 'üá©üá™',
                'United Kingdom': 'üá¨üáß', 'Netherlands': 'üá≥üá±', 'France': 'üá´üá∑',
                'China': 'üá®üá≥', 'India': 'üáÆüá≥', 'Malaysia': 'üá≤üáæ',
                'Thailand': 'üáπüá≠', 'South Korea': 'üá∞üá∑', 'Canada': 'üá®üá¶',
            };
            return flags[country] || 'üåè';
        }

        function toggleCountryDetails(country) {
            const details = document.getElementById(`details-${country.replace(/\s+/g, '-')}`);
            details.classList.toggle('hidden');
        }

        function markPeer(peerAS) {
            const radios = document.getElementsByName(`peer-${peerAS}`);
            let status = null;
            for (const radio of radios) {
                if (radio.checked) {
                    status = radio.value;
                    break;
                }
            }
            if (status) {
                peerVerifications[peerAS] = status;
                updateVerifiedCount();
                showVerificationSummary();
            }
        }

        function updateVerifiedCount() {
            document.getElementById('verifiedCount').textContent = Object.keys(peerVerifications).length;
        }

        function showVerificationSummary() {
            const summary = document.getElementById('verificationSummary');
            const content = document.getElementById('summaryContent');

            if (Object.keys(peerVerifications).length === 0) {
                summary.classList.add('hidden');
                return;
            }

            const activeCount = Object.values(peerVerifications).filter(v => v === 'active').length;
            const obsoleteCount = Object.values(peerVerifications).filter(v => v === 'obsolete').length;
            const unknownCount = Object.values(peerVerifications).filter(v => v === 'unknown').length;

            let html = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">';
            html += `<div><strong>Active:</strong> ${activeCount} peers</div>`;
            html += `<div><strong>Obsolete:</strong> ${obsoleteCount} peers</div>`;
            html += `<div><strong>Unknown:</strong> ${unknownCount} peers</div>`;
            html += '</div>';

            content.innerHTML = html;
            summary.classList.remove('hidden');
        }

        // ====================================================================
        // SUBMIT
        // ====================================================================
        async function submitVerification() {
            if (Object.keys(peerVerifications).length === 0) {
                alert('Please verify at least one peer before submitting.');
                return;
            }

            const currentTime = new Date().toISOString();

            const data = {
                asn: currentASN,
                as_info: currentASData.as_info,
                peer_verifications: peerVerifications,
                timestamp: currentTime,
                total_peers: currentASData.links.length,
                verified_peers: Object.keys(peerVerifications).length,
                summary: {
                    active: Object.values(peerVerifications).filter(v => v === 'active').length,
                    obsolete: Object.values(peerVerifications).filter(v => v === 'obsolete').length,
                    unknown: Object.values(peerVerifications).filter(v => v === 'unknown').length
                }
            };

            downloadJSONBackup(data);
            await submitToGoogleForm(data);
            showSuccessOverlay(data);
        }

        async function submitToGoogleForm(data) {
            const formData = new FormData();
            formData.append(FORM_FIELDS.asn, data.asn);
            formData.append(FORM_FIELDS.email, '');
            formData.append(FORM_FIELDS.data, JSON.stringify(data));
            formData.append(FORM_FIELDS.timestamp, data.timestamp);

            try {
                const iframe = document.createElement('iframe');
                iframe.name = 'hidden_iframe_' + Date.now();
                iframe.style.display = 'none';
                document.body.appendChild(iframe);

                const form = document.createElement('form');
                form.method = 'POST';
                form.action = GOOGLE_FORM_URL;
                form.target = iframe.name;

                for (const [key, value] of formData.entries()) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    form.appendChild(input);
                }

                document.body.appendChild(form);
                form.submit();

                setTimeout(() => {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                }, 2000);
            } catch (error) {
                console.error('Google Form error:', error);
            }
        }

        function downloadJSONBackup(data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AS${data.asn}_verification_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showSuccessOverlay(data) {
            const overlay = document.createElement('div');
            overlay.className = 'success-overlay';
            overlay.innerHTML = `
                <div class="success-modal">
                    <div class="success-icon">‚úì</div>
                    <div class="success-title">Verification Submitted!</div>
                    <div class="success-message">
                        Your verification for AS${data.asn} has been successfully submitted.
                    </div>
                    <div class="success-stats">
                        <div class="success-stat-row">
                            <span class="success-stat-label">AS Number:</span>
                            <span class="success-stat-value">AS${data.asn}</span>
                        </div>
                        <div class="success-stat-row">
                            <span class="success-stat-label">Peers Verified:</span>
                            <span class="success-stat-value">${data.verified_peers} of ${data.total_peers}</span>
                        </div>
                        <div class="success-stat-row">
                            <span class="success-stat-label">Active:</span>
                            <span class="success-stat-value" style="color: #28a745;">${data.summary.active}</span>
                        </div>
                        <div class="success-stat-row">
                            <span class="success-stat-label">Obsolete:</span>
                            <span class="success-stat-value" style="color: #dc3545;">${data.summary.obsolete}</span>
                        </div>
                        <div class="success-stat-row">
                            <span class="success-stat-label">Unknown:</span>
                            <span class="success-stat-value" style="color: #6c757d;">${data.summary.unknown}</span>
                        </div>
                    </div>
                    <div class="success-buttons">
                      <button class="success-btn-primary" onclick="location.reload()">Done</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
        }
    </script>
</body>
</html>